{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="card">
    <h2 class="section-title">ðŸ§­ Learning Roadmap</h2>

    {% if topic_formset %}
    <form method="post">
        {% csrf_token %}
        {{ topic_formset.management_form }}
        {% for cat in categories_with_forms %}
        <section class="roadmap-section">
            <h3>{{ cat.category.name }}</h3>
            <p class="muted">{{ cat.category.description }}</p>

            {% for phase_entry in cat.phases %}
            {% with phase=phase_entry.phase %}
            <div class="phase-card">
                <h4>Phase {{ phase.order }} â€“ {{ phase.title }}</h4>
                <p class="muted">{{ phase.goal }}</p>

                <div class="topics-list">
                    <h5>Topics</h5>
                    {% for t in phase_entry.topics %}
                        <div class="topic-item">
                            {% if t.form %}
                                {{ t.form.topic }}
                                <label class="checkbox-container">
                                    {{ t.form.completed }}
                                    <span>{{ t.form.topic_name|default:t.topic.name }}</span>
                                </label>
                            {% else %}
                                <label class="checkbox-container">
                                    <input type="checkbox" disabled>
                                    <span>{{ t.topic.name }}</span>
                                </label>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>

                <div class="projects-list">
                    <h5>Projects</h5>
                    {% for project in phase_entry.projects %}
                        <div class="project-item">
                            <label class="checkbox-container">
                                <input type="checkbox" data-project-id="{{ project.id }}"
                                    {% if project.id in project_progress %}checked{% endif %}
                                    class="project-checkbox">
                                <span>{{ project.name }}</span>
                            </label>
                        </div>
                    {% endfor %}
                </div>
            </div>
            {% endwith %}
            {% endfor %}

        </section>
        {% endfor %}

        <div style="margin-top:12px;text-align:right">
            <button class="btn" type="submit">Save progress</button>
        </div>
    </form>
    {% else %}
        <p class="muted">Sign in to track your progress. The roadmap is visible below.</p>
        {% for category in categories %}
        <section class="roadmap-section">
            <h3>{{ category.name }}</h3>
            <p class="muted">{{ category.description }}</p>
            {% for phase in category.phases.all %}
            <div class="phase-card">
                <h4>Phase {{ phase.order }} â€“ {{ phase.title }}</h4>
                <p class="muted">{{ phase.goal }}</p>
                <div>
                    <strong>Topics</strong>
                    <ul>
                    {% for topic in phase.topics.all %}
                        <li>
                            <label class="checkbox-container">
                                <input type="checkbox" class="topic-checkbox" data-topic-id="{{ topic.id }}">
                                <span>{{ topic.name }}</span>
                            </label>
                        </li>
                    {% endfor %}
                    </ul>
                </div>
                <div>
                    <strong>Projects</strong>
                    <ul>
                    {% for project in phase.projects.all %}
                        <li>
                            <label class="checkbox-container">
                                <input type="checkbox" class="project-checkbox" data-project-id="{{ project.id }}">
                                <span>{{ project.name }}</span>
                            </label>
                        </li>
                    {% endfor %}
                    </ul>
                </div>
            </div>
            {% endfor %}
        </section>
        {% endfor %}
    {% endif %}

</div>

{% endblock %}

{% block extra_js %}
<script>
// Local checklist persistence for unauthenticated/static users.
// Stores checked topics/projects in localStorage so the static site behaves like a checklist.

function lsKey(type, id) {
    return `roadmap_${type}_${id}`;
}

function saveCheck(type, id, checked) {
    const key = lsKey(type, id);
    try {
        if (checked) localStorage.setItem(key, '1');
        else localStorage.removeItem(key);
    } catch (e) {
        console.warn('localStorage not available', e);
    }
}

function loadChecks() {
    document.querySelectorAll('.topic-checkbox').forEach(cb => {
        const id = cb.getAttribute('data-topic-id');
        if (!id) return;
        const key = lsKey('topic', id);
        if (localStorage.getItem(key)) cb.checked = true;
        cb.addEventListener('change', () => saveCheck('topic', id, cb.checked));
    });
    document.querySelectorAll('.project-checkbox').forEach(cb => {
        const id = cb.getAttribute('data-project-id');
        if (!id) return;
        const key = lsKey('project', id);
        if (localStorage.getItem(key)) cb.checked = true;
        cb.addEventListener('change', () => saveCheck('project', id, cb.checked));
    });
}

function addClearButton() {
    const container = document.querySelector('.card');
    if (!container) return;
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.textContent = 'Clear local checklist';
    btn.style.marginLeft = '8px';
    btn.className = 'btn';
    btn.addEventListener('click', () => {
        // remove all roadmap keys
        try {
            Object.keys(localStorage).forEach(k => {
                if (k.startsWith('roadmap_topic_') || k.startsWith('roadmap_project_')) localStorage.removeItem(k);
            });
            // uncheck all
            document.querySelectorAll('.topic-checkbox, .project-checkbox').forEach(cb => cb.checked = false);
        } catch (e) {
            console.warn('Could not clear localStorage', e);
        }
    });
    const wrapper = document.createElement('div');
    wrapper.style.textAlign = 'right';
    wrapper.style.marginTop = '8px';
    wrapper.appendChild(btn);
    container.prepend(wrapper);
}

document.addEventListener('DOMContentLoaded', () => {
    loadChecks();
    addClearButton();
});
</script>
{% endblock %}